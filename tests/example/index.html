<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>JStatic Starter</title>
  <!-- <link rel="stylesheet" href="theme.css"> -->
  <link href="style.css">
  <style type="text/css">
    /* on mobile, so the buttons are
      hidden but you can still click them */
    @media (max-width: 700px) {
      .nav-button {
        opacity: 0.0;
      }
    }

    body {
      font-family: Georgia;
      line-height: 150%;
    }

    #main {
      margin-left: auto;
      margin-right: auto;
      width: 500px;
    }

    .nav-button {
      position: fixed;
      top: 0;
      height:100%;
      background: inherit;
      border: none;
      font-size:100px;
    }

    #prev {
      left: 10px;
    }

    #prev:after {
      content: "<";
    }

    #next {
      right: 10px;
    }

    #next:after {
      content: ">";
    }

    #search {
      margin-bottom: 30px;
      margin-top: 5px;
      margin-left: auto;
      margin-right: auto;
      width:200px;
    }

    #page {
      max-width: 40px;
      border: 0;
      padding-left: 10px;
      font-family: Georgia;
    }
  </style>
  <title></title>
</head>
<body>
  <div id="search">
      Page:<input id="page" type="number">
      <button onclick="loadPage()">Go</button>
  </div>
  <div id="main">
    <h1 id="title" class="title"></h1>
    <p id="body"></p>
  </div>
  <button id="prev" class="nav-button" onclick="loadPrev()"></button>
  <button id="next" class="nav-button" onclick="loadNext()"></button>

  <script type="text/javascript">
    const configFile = "config.txt";
    const fileListFile = "files.txt";
    let config = {};
    let fileList = [];
    let currentFile = "";
    let rootId = "";

    let sections = {};

    function flatten(json) {
      function _flatten(json, flattened, str_key) {
        for (const key in json) {
          if (json.hasOwnProperty(key)) {
            if (json[key] instanceof Object && json[key] != "") {
              _flatten(
                json[key],
                flattened,
                str_key + (str_key ? "/" : "")  + key);
            } else {
              flattened.push(str_key + "/" + json[key]);
            }
          }
        }
      }
      let flat = [];
      _flatten(json, flat, "");
      return flat;
    }

    function tryParseInt(int) {
      const res = parseInt(int);
      return isNaN(res) ? 0 : res;
    }

    function setText(id, content) {
      document.getElementById(id).textContent = content;
    }

    function scrollToTop() {
      window.scrollTo(0, 0);
    }

    // function getPageFromUrl() {
    //     var urlPage = location.hash;
    //     return tryParseInt(urlPage.split('#')[1]);
    // }

    /**
     Assumes the document contains a title separated by a blank line
     from the rest of the body
    */
    function titleAndBody(text) {
      let lines = text.split('\n');

      setText("title", lines[0]);

      const body = document.querySelector("#body");
      while (body.hasChildNodes()) {
        body.removeChild(body.lastChild);
      }

      lines.slice(2).forEach(line => {
        const paragraph = document.createElement('p');
        paragraph.textContent = line;
        body.appendChild(paragraph);
      });
    }

    function parseSections(lines, parseFn=titleAndBody) {
      titleAndBody(lines);
    }


    function loadFile(file, callback) {
      console.log(`trying to load ${file}`)  // TODO: delete this
      fetch(file).then(response => {
        if (callback) {
          callback(file);
        }

        response.text().then(text => {
          parseSections(text);
          scrollToTop();
        });
      }, function(err) {
        console.log(err);
      }).catch(function(err){
        console.log(err);
      });
    }

    function nextFile() {
      return fileList[
        fileList.indexOf(currentFile) + 1
      ];
    }

    function prevFile() {
      return fileList[
        fileList.indexOf(currentFile) - 1
      ];
    }

    function onFileLoaded(file) {
      currentFile = file;
    }

    function loadNext(getNext=nextFile, callback=onFileLoaded) {
      const next = getNext();
      if (next) {
        loadFile(next, callback);
      }
    }

    function loadPrev(getPrev=prevFile, callback=onFileLoaded) {
      const prev = getPrev();
      if (prev) {
        loadFile(prev, callback);
      }
    }

    // Bootstrap section
    function getIdsTree(element) {
      let ids = [];
      if (!!element.id) {
        ids.push(element.id)
      }
      for (let i in element.children) {
        const childIds = getIdsTree(element.children[i]);
        ids.push(...childIds);
      }
      return ids
    }

    /// Given a list of html elements, get the id of the elements and all their children
    function getIds(elements) {
      let ids = [];
      for (let i in elements) {
        const elIds = getIdsTree(elements[i]);
        ids.push(...elIds);
      }
      return ids;
    }

    function loadConfig() {
      return new Promise(function(resolve, reject){
        fetch(configFile).then(response => {
          response.json().then(res => {
            config = res;
            resolve({config: config});
          });
        });
      })
    }

    function loadFileList() {
      return new Promise(function(resolve, reject){
        fetch(fileListFile).then(response => {
          response.json().then(res => {
            fileList = flatten(res);
            resolve({files: fileList});
          });
        });
      })
    }

    function loadFirstFile() {
      return new Promise(function(resolve, reject){
        loadNext(nextFile);
        resolve();
      })
    }

    function bootstrap() {
      loadConfig()
      .then(loadFileList)
      .then(loadFirstFile);
    }

    bootstrap();
  </script>
  <script>
    // Page-based
    /// this assumes a file ordering scheme with files named 1 to n

    let page = 1;

    function pageToFile(page) {
      return `${config.dir}/${page}.txt`;
    }

    function setPage(page) {
      document.getElementById('page').value = page;
    }

    function loadPage() {
      loadFile(pageToFile(document.getElementById('page').value));
    }

    function nextPage() {
      return pageToFile(page + 1);
    }

    function prevPage() {
      return pageToFile(page - 1);
    }

    function onPageLoaded(file) {
      page = tryParseInt(file.split('/')[1].split('.')[0]);
      setPage(page);
    }
  </script>
  <!-- <script type="text/javascript" src="index.js"></script> -->
</body>
</html>
